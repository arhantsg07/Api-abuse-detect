# API Abuse Detection System

This project implements a basic API abuse detection system using Python (Flask), Redis for data storage, and Envoy as a proxy.

## Features

- *Rate Limiting:* Protects API endpoints from excessive requests based on IP and API key.
- *Reputation Scoring:* Assigns trust scores to clients based on their behavior.
- *Blocking:* Blocks clients with low reputation scores or those identified as anomalous.
- *Anomaly Detection:* Uses an Isolation Forest model trained on usage history to identify unusual patterns.
- *Admin Dashboard:* Provides visibility into rate limits, reputation scores, blocked requests, and model training statistics.

## Project Structure

- main.py: The main Flask application with the public /api endpoint and usage logging.
- admin_metrics.py: Flask application for the admin dashboard endpoints (/admin/metrics, /admin/detection-stats).
- limiter.py: Implements rate limiting logic.
- reputation.py: Handles client reputation scoring and blocking.
- anomaly.py: Logs usage data to Redis.
- detector.py: Contains the anomaly detection logic using the trained model.
- train_model.py: Script to train the anomaly detection model using usage history from Redis.
- redis_client.py: Handles Redis connections.
- config.py: Contains configuration settings (Redis details, rate limits, Envoy URL).
- envoy.yaml: Envoy proxy configuration.
- Api-UI/: Frontend Next.js application for the admin dashboard.
- model.pkl: Trained anomaly detection model (generated by train_model.py).

## Prerequisites

- Python 3.7+
- Redis Server
- Envoy Proxy
- Node.js and npm/yarn (for the frontend)

*For WSL Users:*
- Ensure you have a WSL distribution installed and running.
- You can typically install Redis and other Linux dependencies directly within your WSL environment.

## Setup

1.  *Clone the repository:*
    ``` bash
    git clone <repository_url>
    cd Api-abuse-detect
    ```

2.  *Set up Python Backend:*
    Install Python dependencies:
    ``` bash
    pip install Flask Flask-Cors redis scikit-learn numpy requests
    ```

3.  *Install and Run Redis:*
    - *Linux (WSL):* Use your distribution's package manager (e.g., sudo apt-get update && sudo apt-get install redis-server). Start the service (sudo systemctl start redis-server or equivalent). Redis usually runs on 127.0.0.1:6379 by default.
    - *Windows:* Download and install from [Microsoft Archive](https://github.com/microsoftarchive/redis/releases) or use a package manager like Chocolatey (choco install redis-64). Run the server (redis-server).

4.  *Install Envoy:*
    - *Linux (WSL):* Use your distribution's package manager if available, or download a pre-built binary. Refer to the [Envoy documentation](https://www.envoyproxy.io/docs/envoy/latest/start/install) for detailed installation instructions.
    - *Windows:* Download a pre-built binary from [Envoy releases](https://github.com/envoyproxy/envoy/releases). You'll likely need the envoy.exe file.

5.  *Set up Frontend:*
    Navigate to the frontend directory and install dependencies:
    bash
    cd Api-UI
    npm install # or yarn install
    

## Configuration

- **config.py:** Modify this file to change Redis connection details (REDIS_HOST, REDIS_PORT) or rate limiting parameters (RATE_LIMITS). By default, it's configured for a local Redis instance.
- **envoy.yaml:** This configures the Envoy proxy. Ensure the address and port_value under clusters.backend_service.load_assignment.endpoints point to the correct address and port where your main.py Flask app is running (default: 127.0.0.1:5002).

*WSL Networking Notes:*
- If Redis or your Python apps are running directly in WSL, 127.0.0.1 typically refers to the WSL environment's loopback interface.
- If running components across Windows and WSL, you may need to use the WSL network address or hostnames accessible between environments.

## Running the Application

Open three separate terminal windows (or use a terminal multiplexer like tmux or screen in WSL):

1.  *Start the Redis Server:* (If not already running as a service)
    ``` bash
    sudo systemctl start redis-server
    ```
    Confirm it's running by opening another terminal and running redis-cli ping (should respond with PONG).

2.  *Start the Main API Application:*
    ``` bash
    cd /path/to/Api-abuse-detect
    python main.py
    ```
    This should start the Flask app on 0.0.0.0:5001.

3.  *Start the Admin Metrics Application:*
    ``` bash
    cd /path/to/Api-abuse-detect
    python admin_metrics.py
    ```
    This should start the admin app on 127.0.0.1:8082.

4.  *Start the Envoy Proxy:*
    ``` bash
    cd /path/to/Envoy/binary
    envoy -c /path/to/Api-abuse-detect/envoy.yaml
    ```
    Replace /path/to/Envoy/binary with the directory where you placed the envoy executable and /path/to/Api-abuse-detect with your project root.

5.  *Start the Frontend Dashboard:*
    ``` bash
    cd /path/to/Api-abuse-detect/Api-UI
    npm run dev # or yarn dev
    ```
    This will start the Next.js development server, typically on http://localhost:3000.

## Usage and Testing

- Access the admin dashboard at http://localhost:3000.
- Interact with the API through the Envoy proxy (default: http://localhost:10000).

    **Using curl (Linux/WSL):**
    ``` bash
    curl -H "x-api-key: test-user-123" http://localhost:10000/api
    ```

    **Using Invoke-RestMethod (PowerShell):**
    ``` powershell
    $headers = @{"x-api-key"="test-user-123"}
    Invoke-RestMethod -Uri "http://localhost:10000/api" -Headers $headers
    ```    

- To test rate limiting, make multiple requests rapidly.
- To trigger anomaly detection and model stats updates:
    1. Generate traffic to /api (especially rapid bursts).
    2. Run the training script: python train_model.py (in the backend directory).
    3. Access the admin endpoints: http://localhost:8082/admin/detection-stats and http://localhost:8082/admin/metrics (or refresh the dashboard).

## Model Training

- The train_model.py script now trains the model using the usage_history data collected in Redis from real API requests.
- Run python train_model.py periodically to update the model.pkl file based on recent traffic patterns.

---